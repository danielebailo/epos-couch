$(function(){var a=$("#search-tooltip").simpletip({persistent:true,focus:true,showEffect:"fade",hideEffect:"slide",position:"bottom",showtime:600,offset:[250,-50]}).simpletip();a.load("filter-tip.html");var b=null;var c=null;var d=false;RUfacets.push("searchType");RUvalueMatches["searchType"]=[["AND","OR"]];var e=VS.init({container:$("#search_box_container"),query:"country:click-to-select  ",unquotable:[],callbacks:{search:function(a,b){var c=$("#search_query");var d=b.size();c.stop().animate({opacity:1},{duration:300,queue:false});clearTimeout(window.queryHideDelay);window.queryHideDelay=setTimeout(function(){c.animate({opacity:0},{duration:1e3,queue:false})},2e3)},facetMatches:function(a){a(RUfacets)},valueMatches:function(a,b,c){for(RUfacet in RUfacets){if(RUfacets[RUfacet]==a){c(RUvalueMatches[a][0]);break}}}}});window.ResearchUnit=Backbone.Model.extend({defaults:function(){return{ri_name:"blank name",type_of_ri:"generic type"}},recursiveGet:function(a,b){var c=this;var d=[];for(var e in b){if(_.isArray(b[e])){for(var f in b[e]){var g=c.recursiveGet(a,b[e][f]);d=_.union(d,g)}}else if(_.isObject(b[e])){var g=c.recursiveGet(a,b[e]);d=_.union(d,g)}else if(!_.isObject(b[e])&&!_.isArray(b[e])){if(!_.isUndefined(b[e])){if(a==e){d.push(b[e])}}}}return d}});window.RUList=Backbone.Collection.extend({model:ResearchUnit,url:"_list/only_vals2/allfields_RIaskey",parse:function(a){return _(a.rows).map(function(a){return a})},serverData:null,initialize:function(){var a=this;this.fetch({success:function(){a.serverData=new Backbone.Collection;a.serverData.reset(a.models)},error:function(){}})},filter_results:function(){var a=this.serverData.models;var b=e.searchQuery.models;var c=a;var d=_.find(b,function(a){return a.get("category")=="searchType"});if(b.length>0){if(!$.isEmptyObject(d)&&d.get("value")=="OR"){if(b.length>1){c=[];_.each(b,function(b){c=_.union(c,a.filter(function(a){return a.get(b.get("category"))==b.get("value")}))})}}else{_.each(b,function(b){if(b.get("value")!="AND"){a=a.filter(function(a){return _.any(a.recursiveGet(b.get("category"),a.attributes),function(a){return a==b.get("value")})})}});c=a}}var f=this;this.reset(c)},comparator:function(a){return-a.get("ri_name")},orderBy:function(a){this.comparator=function(b){return b.get(a)};this.sort({silent:true});if(this.ascending==true){this.ascending=false}else{this.models.reverse();this.ascending=true}this.trigger("reset",this,{})}});window.ListOfRU=new RUList;window.loginView=Backbone.View.extend({el:$("#account"),initialize:function(){this.render()},render:function(){var a=this;$(this.el).couchLogin({loggedIn:function(b){$(a.el).append('  - <a href="profile.html" > Edit RIs</a>');d=true;a.trigger("loginChange")},loggedOut:function(){d=false;a.trigger("loginChange")}})}});window.RUView=Backbone.View.extend({tagName:"li",events:{click:"showInfo"},initialize:function(){_.bindAll(this,"showInfo","renderIMG","addIMGlnk","purgeJSONkeys");this.formArray=new Array},JSONri:{},RIrow:0,formArray:null,render:function(){$(this.el).append("<span class=RUitem>"+this.renderIMG()+"<i>"+this.model.get("ri_name")+"</i>"+" - WG "+this.model.get("wg_main")+"</span>");return this},addIMGlnk:function(a,b,c){return'<a href="javascript:"> <img src="img/'+a+'" style="display:inline;vertical-align:middle;float:right;" alt="'+b+'" id="'+c+'">  </a>'},renderIMG:function(){return'<img src="img/'+this.model.get("country")+'_flag.gif" width="25px">  '},showInfo:function(){this.JSONri=getJSONData(JSONriDescription+'?key="'+this.model.get("ri_name")+'"');this.createPopUp()},popUpHTML:function(){var a=this.JSONri;var b=this;var c="";var e=$('<div class="demo-show" />');$(e).prepend("<div class=RUitem style='margin-bottom:10px;text-align:center;font-size:16px;font-weight:bold;'>"+this.renderIMG()+this.model.get("ri_name")+"</div>");var f=$('<div class="demo-show-labelcol" />');var g=$('<div class="demo-show-contentcol" />');this.formArray.length=0;var h=0;this.RIrow=0;for(itemListLabel in a){for(var i in a[itemListLabel]){if(itemListLabel=="financial"&&d==false)continue;switch(itemListLabel){case"ri":$(f).prepend('<h3 class="row'+h+'">RI General Info</h3>');this.RIrow=h;c="ri";break;case"facility":if(a[itemListLabel][i].facility_type=="laboratory"){$(f).append('<h3 class="row'+h+'">'+a[itemListLabel][i].facility_type.toUpperCase().replace(/_/g," ")+":"+a[itemListLabel][i].laboratory_name+"</h3>")}else{$(f).append('<h3 class="row'+h+'">'+a[itemListLabel][i].facility_type.toUpperCase().replace(/_/g," ")+"</h3>")}c=a[itemListLabel][i].facility_type;if(!backboneJSONform.hasOwnProperty(c)){c="generic_facility"}break;default:$(f).append('<h3 class="row'+h+'">'+itemListLabel.toUpperCase()+"</h3>");c=itemListLabel;break}this.formArray[h]=(new Backbone.Form({data:a[itemListLabel][i],schema:backboneJSONform[c]})).render();var j=$('<div class="content row'+h+'" />');var k=$(this.formArray[h].el);$(g).append(j);$(j).append(k);if(itemListLabel=="financial"){$(j).prepend('<span style="display:block;color: red; font-weight:bold;maring:auto;text-align: center;">All the figures are displayed in thousand euros</span>')}h=h+1}$(e).append($(f));$(e).append($(g))}return e},createPopUp:function(){var a=this;$.colorbox({html:a.popUpHTML(),transition:"elastic",speed:400,scrolling:true,width:"850px",height:"700px",onComplete:function(){var b=$(".demo-show-contentcol").css("background-color");var c=$(".demo-show h3").css("background-color");$("div.demo-show div.content").hide();$("div.demo-show div.row"+a.RIrow).show();$("h3.row"+a.RIrow).css("background-color",b);var d="row"+a.RIrow;$("div.demo-show h3").hover(function(){if($(this).attr("class")!=d){$(this).css("background-color",b);$(this).css("cursor","pointer")}},function(){if($(this).attr("class")!=d){$(this).css("background-color",c);$(this).css("cursor","default")}});$("div.demo-show h3").click(function(){$("h3."+d).css("background-color",c);var a="div.demo-show div."+$(this).attr("class");var e="div.demo-show h3."+$(this).attr("class");$(e).css("background-color",b);$("div.demo-show div.content").hide();$(a).fadeToggle("700","linear");d=$(this).attr("class")})}})},backboneFormEditor2JSON:function(a){var b={};for(var c in a){b[c]="";""}return b},purgeJSONkeys:function(a,b){_.each(b,function(b){delete a[b]});return a}});window.itemList=Backbone.View.extend({el:$("#RU-list"),events:{},initialize:function(){_.bindAll(this,"addAll","addOne");ListOfRU.bind("reset",this.addAll)},addOne:function(a){var b=new RUView({model:a});$(this.el).prepend(b.render().el)},addAll:function(){$(this.el).empty();ListOfRU.each(this.addOne)}});window.statToolbarView=Backbone.View.extend({el:$("#graph-control-panel"),xAxisBtn:"#xselect",yAxisBtn:"#yselect",groupByBtn:"#groupselect",listEl:"#count-list",countResultEl:"#count-result",calcEl:"#calculate",financialDropDown:"li#financial-dropdown",fullListHTML:"",parentMcDropDownValue:"",McDropDownXUserValue:"",JSONstatResults:{},initialize:function(){_.bindAll(this,"render","fullListPopUp");this.render(RUfacets);JSONstatResults={};var a=this;$(this.yAxisBtn).mcDropdown("#yselectmenu",{delim:": ",select:function(b,c){if(!_.isUndefined(c)){if(c.indexOf(":")!=-1)a.McDropDownYUserValue=c.split(":")[1].slice(1)}a.parentMcDropDownValue=$("li:contains('"+a.McDropDownYUserValue+"')").parents("li").attr("rel")}});$(this.yAxisBtn).mcDropdown().setValue("default");$(this.xAxisBtn).mcDropdown("#xselectmenu",{delim:": ",select:function(b,c){a.McDropDownXUserValue=$("#xselectmenu li[rel="+b+"]").text()}});$(this.xAxisBtn).mcDropdown().setValue("default")},events:{"change #yselect":"onYchange","click #count-list":"fullListPopUp","click #calculate":"goStat"},render:function(a){$(this.el).find(this.countResultEl).val("tot");var b=this;$.couch.session({success:function(a){if(_.isNull(a.userCtx.name)){$(b.financialDropDown).hide()}else{$(b.financialDropDown).show()}}})},onYchange:function(){},goStat:function(){if(this.getYAxisBtnVal()=="default"||this.getXAxisBtnVal()=="default"){window.alert("Please select both X axis and Y axis value ");return null}this.JSONstatResults={};var a=this;var b=a.getXAxisBtnVal();var c=ListOfRU.pluck("ri_name");var d={keys:c};var e=[];var f="_list/"+a.parentMcDropDownValue+"/allfields_RIaskey";$.ajax({contentType:"application/json",async:true,url:f,type:"POST",data:JSON.stringify(d),dataType:"json",timeout:15e3,beforeSend:function(){a.trigger("startCalculating")},complete:function(){a.trigger("stopCalculating")},success:function(c){e=c.rows;var d=_.groupBy(e,function(a){return a["value"][b]});a.JSONstatResults[b]=d;a.trigger("drawGraph")},error:function(a,b,c){alert(" Server reported error "+a.status+":"+c)}})},fullListPopUp:function(){},getYAxisBtnVal:function(){return $(this.el).find(this.yAxisBtn).val()},getXAxisBtnVal:function(){return $(this.el).find(this.xAxisBtn).val()},getGroupByBtnVal:function(){return this.$(this.el).find(this.groupByBtn).val()},getCntBoxVal:function(){return parseInt($(this.el).find(this.countResultEl).val())},getJSONstatResults:function(){return this.JSONstatResults},setCntBoxVal:function(a){$(this.el).find(this.countResultEl).val(a);$(this.el).find(this.countResultEl).css({color:"#"+((1<<24)*Math.random()|0).toString(16)})}});graphToolbar=new statToolbarView;window.GraphView=Backbone.View.extend({el:$("#stat-box"),graphEl:$("#graph"),initialize:function(){_.bindAll(this,"draw","startCalc","stopCalc");graphToolbar.bind("drawGraph",this.draw);graphToolbar.bind("startCalculating",this.startCalc);graphToolbar.bind("stopCalculating",this.stopCalc);var a=this;Highcharts.setOptions({lang:{FullScreenButtonTitle:"View full Size"}});this.chartOptions={series:[{name:"example",data:[83.6,78.8,98.5,93.4,106]}],chart:{renderTo:a.graphEl.selector.slice(1,a.graphEl.selector.length),type:"column"},loading:{hideDuration:1e3,showDuration:1e3,labelStyle:{fontWeight:"bold","font-size":"2.5em",color:"#CF2020"},style:{background:"url('img/loading/loading-gif-animation-small-02.gif') no-repeat center"}},title:{text:"EPOS STATS - EXAMPLE"},xAxis:{categories:["europe","united states","africa","oceania","asia"],labels:{rotation:-45,align:"right",x:-20,style:{font:"normal 13px Verdana, sans-serif",fontWeight:"bold"},formatter:function(){var a=this.value.charAt(0).toUpperCase()+this.value.slice(1);a=a.replace("_"," ");return a}}},yAxis:{min:0,title:{text:"Quantity"}},legend:{layout:"horizontal",backgroundColor:"#FFFFFF",align:"right",verticalAlign:"top",x:-75,y:20,floating:true,shadow:true,enabled:false},tooltip:{formatter:function(){return""+this.x+": "+this.y}},credits:{enabled:false},plotOptions:{column:{stacking:null,pointPadding:.2,borderWidth:0,dataLabels:{enabled:true,formatter:function(){return this.y}}}},exporting:{buttons:{popUpBtn:{enabled:false,symbol:"square",_titleKey:"FullScreenButtonTitle",x:-60,symbolSize:18,symbolFill:"#B5C9DF",hoverSymbolFill:"#779ABF",onclick:function(){generalPurposeGlobalVar=this;var a=window.open("./chartpopup.html","Full Size Chart","location=0,titlebar=0,status=0,width=780,height=650")}},exportButton:{enabled:true},printButton:{enabled:true}}}};this.highChart=new Highcharts.Chart(this.chartOptions)},hide:function(){$(this.el).hide(600)},show:function(){$(this.el).show(600)},startCalc:function(){this.highChart.showLoading("...loading data...")},stopCalc:function(){this.highChart.hideLoading()},draw:function(){var a=graphToolbar.getJSONstatResults();var b=this.createSerie(a[graphToolbar.getXAxisBtnVal()],graphToolbar.getYAxisBtnVal());this.drawSerie(b.categories,b.serie)},createSerie:function(a,b){var c=this;var d=[];var e=[];var f=0;for(var g in a){e.push(g)}var h={name:b,data:zeros([e.length])};var i=backboneJSONform[graphToolbar.parentMcDropDownValue][b]["type"];_.each(a,function(a,c,d){var e=new Object;_.each(a,function(a,c,d){var g=a["value"][b];if(!_.isUndefined(g)&&!_.isNull(g)){if(i=="Text"||i=="Select"){if(!e.hasOwnProperty(g)){e[g]=1;h.data[f]=h.data[f]+1}}if(i=="List"){h.data[f]=h.data[f]+g.length}if(i=="Number"){var j=_.isNumber(g)?g:0;h.data[f]=h.data[f]+j}}});h.data[f]=Math.floor(h.data[f]);delete e;++f});return{categories:{categories:e},serie:h}},drawSerie:function(a,b){var c=graphToolbar.McDropDownYUserValue;this.chartOptions.xAxis.categories=a.categories;this.chartOptions.tooltip={formatter:function(){return graphToolbar.McDropDownXUserValue+": "+"<b>"+this.x+"</b><br/>"+c+"<b>: "+this.y+"</b><br/>"}};this.chartOptions.yAxis={min:0,title:{text:c,style:{fontSize:"18px"}}};var d=graphToolbar.McDropDownYUserValue+" per "+graphToolbar.McDropDownXUserValue;this.chartOptions.title={text:d};this.chartOptions.series=[b];this.highChart=new Highcharts.Chart(this.chartOptions);this.highChart.redraw()}});window.TotalView=Backbone.View.extend({el:$("#total-items"),initialize:function(){_.bindAll(this,"updateTotal");ListOfRU.bind("reset",this.updateTotal)},updateTotal:function(){$(this.el).html(' <span class="number" >'+ListOfRU.length+"</span> Research Infrastructures listed")}});window.EPOSinfoView=Backbone.View.extend({el:$("#epos-info-box"),initialize:function(){this.updateTotal()},updateTotal:function(){var a=[];a[0]="EPOS is: "+getJSONData(QUERYnumberOfRI).rows[0].value+" Research Infrastructures";a[1]="EPOS is:  "+getJSONData(QUERYnumberOfCountries).rows.length+" Countries";a[2]="EPOS is:  "+getJSONData(QUERYnumberOfInstitutions).rows.length+" Institutions";a[3]="EPOS is:  "+getJSONData(QUERYnumberOfLabs).rows[0].value+" Laboratories";a[4]="EPOS is:  "+getJSONData(QUERYnumberOfTotalStations).rows[0].value+" Seismic and GPSStations";var b={duration:1500,rearrangeDuration:700,effect:"random",centered:true};$(this.el).textualizer(a,b);$(this.el).textualizer("start")}});window.VSview=Backbone.View.extend({initialize:function(){_.bindAll(this,"searchOnEnter");this.VSobject=e;this.id=e.searchBox.id;this.VSobject.searchQuery.bind("reset",this.searchOnEnter)},searchOnEnter:function(){ListOfRU.filter_results()}});window.mapBox=Backbone.View.extend({el:$("#map-box"),mapEl:$("#RImap"),ctrlPanelEl:$("#map-control-panel"),initialize:function(){_.bindAll(this,"showRIsOnMap","clearMarkers");ListOfRU.bind("reset",this.showRIsOnMap);this.fullScreen=false;this.markersArray=[];var a=document.getElementById($(this.mapEl).attr("id"));var b=[{featureType:"transit.line",elementType:"labels",stylers:[{visibility:"off"}]},{},{featureType:"administrative.land_parcel",stylers:[{visibility:"off"}]},{featureType:"administrative.province",stylers:[{visibility:"off"}]},{featureType:"administrative.neighborhood",stylers:[{visibility:"off"}]},{featureType:"road.highway.controlled_access",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road",stylers:[{visibility:"off"}]},{}];var c=new google.maps.StyledMapType(b,{name:"Simple"});var d={zoom:2,center:new google.maps.LatLng(47.7732,11.7773),mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.HYBRID,"simple_map"]}};this.map=new google.maps.Map(a,d);this.map.mapTypes.set("simple_map",c);this.map.setMapTypeId(google.maps.MapTypeId.HYBRID)},clearMarkers:function(){if(this.markersArray){for(i in this.markersArray){this.markersArray[i].setMap(null)}}},events:{"click #show-on-map-button":"showRIsOnMap","click #full-screen-map":"toggleFullScreen"},hide:function(){$(this.el).hide(600)},show:function(){$(this.el).show(600)},toggleFullScreen:function(){if(this.fullScreen==false){this.fullScreen=true;this.originalCSS={width:$(this.el).css("width"),height:$(this.el).css("height"),overflow:$(this.el).css("overflow"),position:$(this.el).css("position"),top:$(this.el).css("top"),left:$(this.el).css("left"),"z-index":$(this.el).css("z-index")};$(this.el).css({width:$(window).width(),height:$(window).height(),overflow:"visilble",position:"fixed",top:"0px",left:"0px","z-index":"100000000"})}else{this.fullScreen=false;$(this.el).css(this.originalCSS)}},showRIsOnMap:function(){var a=this;var b=ListOfRU.pluck("ri_name");var c={keys:b};var d=[labCoordsView,netStationsCoordsView,GPSCoordsView];var e=new progressBar({height:"2.3em",width:"250px",top:"50px",right:"25px",colorBar:"#F8F946",background:"#FFF",fontFamily:"Arial, sans-serif",fontSize:"14px"});this.clearMarkers();for(var f in d){$.ajax({contentType:"application/json",async:true,url:d[f],type:"POST",data:JSON.stringify(c),dataType:"json",timeout:1e4,complete:function(a,b){if(b=="timeout"||b=="abort"){e.hide()}},success:function(b){a.map.controls[google.maps.ControlPosition.RIGHT].push(e.getDiv());dataArray=b;e.start(dataArray.rows.length);var c=new google.maps.Geocoder;var d="";var f=0;_.each(dataArray.rows,function(b){var c=new google.maps.LatLng(b.value[0],b.value[1]);if(c.lat==0||c.lng()==0){var d=e.getTotal()-1;e.setTotal(d)}if(c.lat!=0&&c.lng()!=0){var g="img/"+b.value[3]+"-icon.png";setTimeout(function(){var d=new google.maps.Marker({map:a.map,position:c,icon:g,flat:false});a.markersArray.push(d);e.updateBar(1);var f=b.value[2];var h=new google.maps.InfoWindow({content:f});google.maps.event.addListener(d,"click",function(){h.open(a.map,d)});if(e.getCurrent()>e.getTotal()-1){e.hide()}},f*1)}f=f+1})},error:function(a){alert("Connection Error: some stations could be missing. Try reloading the page.")}})}this.unOverlapMrkrs()},unOverlapMrkrs:function(){this.markersArray=_.sortBy(this.markersArray,function(a){a.getPosition().lat()});var a=new google.maps.LatLng(0,0);_.each(this.markersArray,function(b){var c=b.getPosition();if(c.lat()==a.lat()){var d=c.lat()+Math.random()*.001;var e=c.lng()+Math.random()*.001;var f=new google.maps.LatLng(d,e);b.setPosition(f)}a=c});return true},clusterizeMrkrs:function(){var a={gridSize:1,maxZoom:15,imagePath:"img/transparent02-icon.png",styles:[{url:"img/transparent02-icon.png",height:15,width:15,textColor:"#000000"}]};var b=new MarkerClusterer(this.map,this.markersArray,a)}});window.navigationBar=Backbone.View.extend({el:$("#nav1.navigare ul li a.ajax"),initialize:function(){$(this.el).colorbox({transition:"elastic",speed:400,width:"850px",height:"700px"})}});window.AppView=Backbone.View.extend({el:$("#wholepage"),events:{"change #item-orderby select":"orderBy","click #item-orderby img":"orderBy","click #bottone":"raggruppa",'click .navigare ul li a[href="#map"]':"showMap",'click .navigare ul li a[href="#stat"]':"showStat"},initialize:function(){this.RUlistView=new itemList;this.total=new TotalView;this.searchBox=new VSview;this.statChart=new GraphView;this.DBloginView=new loginView;this.DBloginView.bind("loginChange",graphToolbar.render);this.eposGoogleMap=new mapBox;this.EPOSinfobox=new EPOSinfoView;this.showMap()},orderBy:function(){ListOfRU.orderBy($(this.el).find("#item-orderby select").val())},raggruppa:function(){this.statChart.groupByValue("country")},showMap:function(){this.eposGoogleMap.show();this.statChart.hide()},showStat:function(){this.eposGoogleMap.hide();this.statChart.show()}});window.App=new AppView})
