$("#welcome").couchLogin({loggedIn:function(a){var b=a.name;var c=a.roles;var d=a.key;var e={};_.extend(e,Backbone.Events);e.on("log",function(a){$.couch.db(logDB).saveDoc(a,{success:function(a){},error:function(a){alert("log error: ",a)}})});var f="epos-couch";var g="ride-users";var h=VS.init({container:$("#search_box_container"),query:" ",unquotable:["text","account","filter","access"],callbacks:{search:function(a,b){var c=$("#search_query");var d=b.size();c.stop().animate({opacity:1},{duration:300,queue:false});clearTimeout(window.queryHideDelay);window.queryHideDelay=setTimeout(function(){c.animate({opacity:0},{duration:1e3,queue:false})},2e3)},facetMatches:function(a){a(RUfacets)},valueMatches:function(a,b,c){for(RUfacet in RUfacets){if(RUfacets[RUfacet]==a){c(RUvalueMatches[a][0]);break}}}}});window.ResearchUnit=Backbone.Model.extend({defaults:function(){return{ri_name:"blank name",type_of_ri:"generic type"}},initialize:function(){}});window.RUList=Backbone.Collection.extend({model:ResearchUnit,url:function(){return"_list/only_vals2/allfields"},parse:function(a){if(b=="admin"||b=="epos-couch"||$.inArray("admin",c)==0){return _(a.rows).map(function(a){return a})}var d=$.couch.db(g);var e=RIDEusersGetUsers+'?key="'+b+'"';var f=getJSONData(e);if(f.rows.length!=0){f=f.rows[0]["value"]}else{f=[]}var h=_(a.rows).map(function(a){var b=true;if(!_.isEmpty(f)){_.each(f,function(c,d){if(a[d]!=c){b=false}})}if(b==true){return a}});return _(h).filter(function(a){if(!_.isUndefined(a)){return a}})},initialize:function(){selfino=this;this.fetch({success:function(){selfino.serverData=new Backbone.Collection;selfino.serverData.reset(selfino.models)},error:function(){}})},comparator:function(a){return-a.get("ri_name")},orderBy:function(a){this.comparator=function(b){return b.get(a)};this.sort({silent:true});if(this.ascending==true){this.ascending=false}else{this.models.reverse();this.ascending=true}this.trigger("reset",this,{})},filter_results:function(){var a=this.serverData.models;var b=h.searchQuery.models;if(b.length>0){_.each(b,function(b){a=a.filter(function(a){return a.get(b.get("category"))==b.get("value")})})}this.reset(a)}});window.ListOfRU=new RUList;window.RIform=Backbone.Form.extend({data:{id:123,name:"Rod Kimble",password:"cool beans"},schema:{wg_main:{type:"Number"},ri_name:{}}});window.RUView=Backbone.View.extend({tagName:"li",events:{"click #edit":"updateRI","click #delete":"deleteRI"},initialize:function(){_.bindAll(this,"updateRI","renderIMG","addIMGlnk","deleteRI","purgeJSONkeys","saveRI");this.formArray=new Array},JSONri:{},RIrow:0,formArray:null,render:function(){$(this.el).append("<span class=ri-item>"+this.renderIMG()+this.model.get("ri_name")+" - WG"+this.model.get("wg_main")+"   "+this.addIMGlnk("edit.gif","Edit RI","edit")+"   "+this.addIMGlnk("delete.gif","Delete RI","delete")+"</span>");return this},addIMGlnk:function(a,b,c){return'<a href="javascript:"> <img src="img/'+a+'" style="display:inline;vertical-align:middle;float:right;margin-right:5px;" alt="'+b+'" id="'+c+'">  </a>'},renderIMG:function(){return'<img src="img/'+this.model.get("country")+'_flag.gif" width="25px">  '},saveRI:function(){self=this;var a="error";var c="none";for(var d in this.formArray){if(this.formArray[d].data.doctype=="ri"){a=this.formArray[d].getValue().ri_name}if(this.formArray[d].data.country!=null){c=this.formArray[d].getValue().country}}if(a=="error"){window.alert("uhu..? Error in SaveRI function. Report it at daniele.bailo@ingv.it");return}for(d in this.formArray){docToSave=this.formArray[d].getValue();docToSave["ri_name"]=a;if(docToSave._rev=="")delete docToSave._rev;var g=0;self=this;$.couch.db(f).saveDoc(docToSave,{success:function(){g=g+1;if(g==self.formArray.length){if(self.model.set({ri_name:a,country:c})){self.updateRI();e.trigger("log",{user:b,date:new Date,action:"Save",ri_name:a})}$("#updatebtn").append('<div id="savemsg" style="color:green;top:130px; position:relative;"/>');$("#savemsg").append("<b> UPDATE SUCCESFULL</b>").fadeOut(1e3)}},error:function(a){window.alert("Uh..got an error when saving.. NOtify it to  daniele.bailo@ingv.it and report 'ERROR CODE: updateDBerror'. Thanks --  ERROR:"+a)}})}},updateRI:function(){this.JSONri=getJSONData(JSONriDescription+'?key="'+this.model.get("ri_name")+'"');this.createPopUp()},deleteRI:function(){itemsToDelete=getJSONData(JSONriDescription+'?key="'+this.model.get("ri_name")+'"');var a=0;if(confirm("Are you sure you want to delete this Research infrastructure?\n YOU WILL NOT BE ABLE TO RECOVER IT!'")){if(confirm("REALLY SURE?\n:-)")){for(itemListLabel in itemsToDelete){for(var c in itemsToDelete[itemListLabel]){var d=itemsToDelete[itemListLabel][c]._id;var g=itemsToDelete[itemListLabel][c]._rev;var h={_id:d,_rev:g};$.couch.db(f).removeDoc(h,{success:function(){a=a+1;e.trigger("log",{user:b,date:new Date,action:"delete",ri_name:itemsToDelete[itemListLabel][c]["ri_name"]})}})}}}}ListOfRU.fetch({success:function(){ListOfRU.serverData.reset(ListOfRU.models);ListOfRU.filter_results()}});this.waitUpdate()},waitUpdate:function(){$(document.body).append('<div id="loadimage"> <img  src="img/loading/updating-animated.gif" ></div>');$("#loadimage").css("position","fixed").css("top","30%").css("left","40%").css("border-style","solid").css("border-width","1px");window.setTimeout("$('#loadimage').remove()",2e3)},popUpHTML:function(){var a=this.JSONri;var b=this;var c="";var d=$('<div class="demo-show" />');$(d).prepend("<div class=RUitem style='margin-bottom:10px;text-align:center;font-size:14px;font-weight:bold;color:red;'> Do not waste your efforts: SAVE ALL CHANGES before closing this popup.</div>");$(d).prepend("<div class=RUitem style='margin-bottom:10px;text-align:center;font-size:16px;font-weight:bold;'>"+this.renderIMG()+this.model.get("ri_name")+"</div>");var e=$('<div class="demo-show-labelcol" />');var f=$('<div class="demo-show-contentcol" />');this.formArray.length=0;var g=0;this.RIrow=0;for(itemListLabel in a){for(var h in a[itemListLabel]){switch(itemListLabel){case"ri":$(e).prepend('<h3 class="row'+g+'">RI General Info</h3>');this.RIrow=g;c="ri";break;case"facility":if(a[itemListLabel][h].facility_type=="laboratory"){$(e).append('<h3 class="row'+g+'">'+a[itemListLabel][h].facility_type.toUpperCase().replace(/_/g," ")+" - "+a[itemListLabel][h].laboratory_name+"</h3>")}else{if(a[itemListLabel][h].hasOwnProperty("facility_type")){$(e).append('<h3 class="row'+g+'">'+a[itemListLabel][h].facility_type.toUpperCase().replace(/_/g," ")+"</h3>")}else{$(e).append('<h3 class="row'+g+'">'+"UNKNOWN FACILITY"+"</h3>")}}c=a[itemListLabel][h].facility_type;if(!backboneJSONform.hasOwnProperty(c)){c="generic_facility"}break;default:$(e).append('<h3 class="row'+g+'">'+itemListLabel.toUpperCase().replace(/_/g," ")+"</h3>");c=itemListLabel;break}this.formArray[g]=(new Backbone.Form({data:a[itemListLabel][h],schema:backboneJSONform[c]})).render();var i=$('<div class="content row'+g+'" />');var j=$(this.formArray[g].el);$(f).append(i);$(i).append(j);if(itemListLabel=="financial"){$(i).prepend('<span style="display:block;color: red; font-weight:bold;maring:auto;text-align: center;">All the figures are displayed in thousand euros</span>')}if(itemListLabel!="ri"){var k=$('<span id="remove-item" name="'+a[itemListLabel][h]._id+'"style="display:block; font-weight:bold;text-align: right; margin-right:10px;margin bottom:30px;color:grey;cursor:pointer;"></span>');$(k).append('Remove  <img src="img/icon-close.gif" />');$(k).click(function(){b.removeItem($(this).attr("name"))});$(i).prepend($(k))}g=g+1}$(d).append($(e));$(d).append($(f))}$(d).append('<div id="updatebtn">SAVE ALL</div> ').delegate("#updatebtn","click",this.saveRI);var l=$('<ul id="item-nav">			<li>ADD ITEM (layer 2)			  <ul>			    <li><span id="#">+ Facility / Resources </span>			      <ul>				<li><span id="addSeismicNet">Seismic Network</span></li>				<li><span id="addGNSSnet">GNSS Network</span></li>				<li><span id="addDataProc">Data Process facility</span></li>                <li><span id="addLab">Laboratory</span></li>                <li><span id="addVolcRemSens">Volcano Rem. Sensing</span></li>                <li><span id="addObsInstrNet">Observation Inst. Network</span></li>                <!--<li><span id="#">Marine Facilities</span></li>                <li><span id="#">Gravimetric (set of Inst.)</span></li>                <li><span id="#">Geomagnetic (set of Inst.)</span></li>				--></ul>			    </li>                <li><span id="#">+ Datacentre </span>                <ul>                    <li><span id="addDC"> Seismic DataCentre</span></li>                <li><span id="addGNSSDC"> GNSS DataCentre</span></li>                </ul>                </li>			    <li><span id="addDB">Data Archive</span></li>			    <li><span id="addFinancial">Financial</span></li>                <li><span id="addComments">Comments</span></li>			  </ul>			</li>		    </ul>');$(d).append($(l));$(d).append('<div id="discard">EXIT</div> ');return d},createPopUp:function(){var a=this;$.colorbox({html:a.popUpHTML(),transition:"elastic",speed:400,scrolling:true,width:"850px",height:"700px",onClosed:function(){$(document.body).append('<div id="loadimage"> <img  src="img/loading/updating-animated.gif" ></div>');$("#loadimage").css("position","fixed").css("top","30%").css("left","40%").css("border-style","solid").css("border-width","1px");window.setTimeout("$('#loadimage').remove()",2e3);ListOfRU.fetch({success:function(){ListOfRU.serverData.reset(ListOfRU.models);ListOfRU.filter_results()}})},onComplete:function(){var b=$(".demo-show-contentcol").css("background-color");var c=$(".demo-show h3").css("background-color");$("div.demo-show div.content").hide();$("div.demo-show div.row"+a.RIrow).show();$("h3.row"+a.RIrow).css("background-color",b);var d="row"+a.RIrow;$("div.demo-show h3").hover(function(){if($(this).attr("class")!=d){$(this).css("background-color",b);$(this).css("cursor","pointer")}},function(){if($(this).attr("class")!=d){$(this).css("background-color",c);$(this).css("cursor","default")}});$("div.demo-show h3").click(function(){$("h3."+d).css("background-color",c);var e="div.demo-show div."+$(this).attr("class");var f="div.demo-show h3."+$(this).attr("class");$(f).css("background-color",b);$("div.demo-show div.content").hide();$(e).fadeToggle("700","linear");d=$(this).attr("class");a.refreshForms()});$("#discard").click(function(){$.colorbox.close()});$("#item-nav").hover(function(){$(this).addClass("iehover")},function(){$(this).removeClass("iehover")});$("#addSeismicNet").click(function(){a.refreshForms();a.addFacility("seismic_net");a.createPopUp()});$("#addGNSSnet").click(function(){a.refreshForms();a.addFacility("gnss_net");a.createPopUp()});$("#addLab").click(function(){a.refreshForms();a.addFacility("laboratory");a.createPopUp()});$("#addDataProc").click(function(){a.refreshForms();a.addFacility("data_processing_facility");a.createPopUp()});$("#addVolcRemSens").click(function(){a.refreshForms();a.addFacility("volcano_remote_sensing");a.createPopUp()});$("#addObsInstrNet").click(function(){a.refreshForms();a.addFacility("observation_instrument_network");a.createPopUp()});$("#addDC").click(function(){a.refreshForms();a.addDC();a.createPopUp()});$("#addGNSSDC").click(function(){a.refreshForms();a.addGNSSDC();a.createPopUp()});$("#addDB").click(function(){a.refreshForms();a.addDB();a.createPopUp()});$("#addFinancial").click(function(){a.refreshForms();a.addFinancial();a.createPopUp()});$("#addComments").click(function(){a.refreshForms();a.addComments();a.createPopUp()})}})},addFacility:function(a){if(this.JSONri.hasOwnProperty("facility")==false){this.JSONri.facility=[]}var c=this.backboneFormEditor2JSON(backboneJSONform[a]);c.facility_type=a;c._id=randomHashString();c.doctype="facility";c.facility_type=a;c.ri_name=this.model.get("ri_name");delete c._rev;this.JSONri.facility.push(c);e.trigger("log",{user:b,date:new Date,action:"addFacility",ri_name:this.model.get("ri_name")})},addDC:function(){if(this.JSONri.hasOwnProperty("datacentre")==false){this.JSONri.datacentre=[]}var a=this.backboneFormEditor2JSON(backboneJSONform.datacentre);a._id=randomHashString();a.doctype="datacentre";a.ri_name=this.model.get("ri_name");delete a._rev;this.JSONri.datacentre.push(a);e.trigger("log",{user:b,date:new Date,action:"addDC",ri_name:this.model.get("ri_name")})},addGNSSDC:function(){if(this.JSONri.hasOwnProperty("gnss_datacentre")==false){this.JSONri.gnss_datacentre=[]}var a=this.backboneFormEditor2JSON(backboneJSONform.gnss_datacentre);a._id=randomHashString();a.doctype="gnss_datacentre";a.ri_name=this.model.get("ri_name");delete a._rev;this.JSONri.gnss_datacentre.push(a);e.trigger("log",{user:b,date:new Date,action:"addGNSSDC",ri_name:this.model.get("ri_name")})},addDB:function(){if(this.JSONri.hasOwnProperty("dataarchive")==false){this.JSONri.dataarchive=[]}var a=this.backboneFormEditor2JSON(backboneJSONform.dataarchive);a._id=randomHashString();a.doctype="dataarchive";a.ri_name=this.model.get("ri_name");delete a._rev;this.JSONri.dataarchive.push(a);e.trigger("log",{user:b,date:new Date,action:"addDB",ri_name:this.model.get("ri_name")})},addFinancial:function(){if(this.JSONri.hasOwnProperty("financial")==false){this.JSONri.financial=[]}var a=this.backboneFormEditor2JSON(backboneJSONform.financial);a._id=randomHashString();a.doctype="financial";a.ri_name=this.model.get("ri_name");delete a._rev;this.JSONri.financial.push(a);e.trigger("log",{user:b,date:new Date,action:"addFinancial",ri_name:this.model.get("ri_name")})},addComments:function(){if(this.JSONri.hasOwnProperty("comment_form")==false){this.JSONri.comment_form=[]}var a=this.backboneFormEditor2JSON(backboneJSONform.comment_form);a._id=randomHashString();a.doctype="comment_form";a.ri_name=this.model.get("ri_name");delete a._rev;this.JSONri.comment_form.push(a);e.trigger("log",{user:b,date:new Date,action:"addComments",ri_name:this.model.get("ri_name")})},removeItem:function(a){var b=this;for(itemListLabel in this.JSONri){for(var c in this.JSONri[itemListLabel]){if(this.JSONri[itemListLabel][c]._id==a&&confirm("Are you sure you want to delete this item?\n You'll not be able to recover it.'")){var d=this.JSONri[itemListLabel][c]._id;var e=this.JSONri[itemListLabel][c]._rev;var g={_id:d,_rev:e};$.couch.db(f).removeDoc(g,{success:function(){$("#updatebtn").append('<div id="savemsg" style="color:green;top:130px; position:relative;"/>');$("#savemsg").append("<b> UPDATE SUCCESFULL</b>").fadeOut(3e3)}});delete this.JSONri[itemListLabel][c]}}}this.createPopUp();return},backboneFormEditor2JSON:function(a){var b={};for(var c in a){b[c]="";""}return b},refreshForms:function(){var a=new Object;var b=new Object;for(itemForm in this.formArray){b=this.formArray[itemForm].getValue();if(a[b["doctype"]]==undefined){a[b["doctype"]]=new Array}a[b["doctype"]].push(b)}delete this.JSONri;this.JSONri=a},purgeJSONkeys:function(a,b){_.each(b,function(b){delete a[b]});return a}});window.itemList=Backbone.View.extend({el:$("#ri-list"),events:{},initialize:function(){_.bindAll(this,"addAll","addOne");ListOfRU.bind("reset",this.addAll);$("#addRiBtn span").on("click",this.addRI)},addOne:function(a){var b=new RUView({model:a});$(this.el).prepend(b.render().el)},addAll:function(){$(this.el).empty();ListOfRU.each(this.addOne)},addRI:function(){var a=randomHashString();var c=new ResearchUnit({_id:a,doctype:"ri",ri_name:"Name format: Institution - RI name"});var d=new RUView({model:c});$(this.el).prepend(d.render().el);d.JSONri={ri:[{_id:a,doctype:"ri",ri_name:"Name format: Institution - RI name",country:b,wg_main:b.substring(2)}]};e.trigger("log",{user:b,date:new Date,action:"addRI"});d.createPopUp()}});window.VSview=Backbone.View.extend({initialize:function(){_.bindAll(this,"searchOnEnter");this.VSobject=h;this.id=h.searchBox.id;this.VSobject.searchQuery.bind("reset",this.searchOnEnter)},searchOnEnter:function(){ListOfRU.filter_results()}});window.floatingText=Backbone.View.extend({el:$("#epos-info-box"),initialize:function(){this.updateTotal()},updateTotal:function(){var a=[];a[0]="Welcome to the RIDE Research Infrastructure Update Page!";a[1]="Need help? Click on the help button above.";a[2]="Tip 1: Each row is a Research Infrastructure. Icons on the left: delete/modify it.";a[3]="Tip 2: to add a RI click on 'add RI' below-left the searchbar";a[4]="Tip 3: filter the list of RI with the searchbar. Write 'country: YOUR-COUNTRY' and hit enter";var b={duration:3e3,rearrangeDuration:700,effect:"random",centered:true};$(this.el).textualizer(a,b);$(this.el).textualizer("start")}});window.AppView=Backbone.View.extend({el:$("#content"),events:{"change #item-orderby select":"orderBy","click #item-orderby img":"orderBy","click .login input[type='submit']":"resetList","click #reload":"reload"},initialize:function(){this.listView=new itemList;this.searchBox=new VSview;this.floatingHeaderText=new floatingText;e.trigger("log",{user:b,date:new Date,action:"login"})},orderBy:function(){ListOfRU.orderBy($(this.el).find("#item-orderby select").val())},reload:function(){$(document.body).append('<div id="loadimage"> <img  src="img/loading/updating-animated.gif" ></div>');window.location.reload()},resetList:function(){self=this;$("#welcome").couchLogin({loggedIn:function(a){self.reload()}})}});window.App=new AppView},loggedOut:function(){$("a#welcome").remove();$("#ri-list").remove()}})
